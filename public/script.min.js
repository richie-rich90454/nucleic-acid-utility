document.addEventListener("DOMContentLoaded",(function(){let e=$("#sequence"),n=$("#conversionType"),t=$("#showBaseNames"),i=$("#colorizeSequence"),o=$("#result"),l=$("#error"),r=$("#base-buttons"),c=$("#delete-last"),s=$("#clear-all"),a=$("#copy-results"),A=$("#reset-all"),u=$("#visualizer-container"),d=$("#visualizer-title"),C=$(".amino-acid-tooltip"),h=document.getElementById("sequence-visualizer"),f=h.getContext("2d"),p=["A","T","G","C"],G=["A","U","G","C"],g=["DNA_COMPLEMENT","RNA_COMPLEMENT","DNA_TRANSCRIPT"],U={UUU:"Phenylalanine",UUC:"Phenylalanine",UUA:"Leucine",UUG:"Leucine",CUU:"Leucine",CUC:"Leucine",CUA:"Leucine",CUG:"Leucine",AUU:"Isoleucine",AUC:"Isoleucine",AUA:"Isoleucine",AUG:"Methionine",GUU:"Valine",GUC:"Valine",GUA:"Valine",GUG:"Valine",UCU:"Serine",UCC:"Serine",UCA:"Serine",UCG:"Serine",CCU:"Proline",CCC:"Proline",CCA:"Proline",CCG:"Proline",ACU:"Threonine",ACC:"Threonine",ACA:"Threonine",ACG:"Threonine",GCU:"Alanine",GCC:"Alanine",GCA:"Alanine",GCG:"Alanine",UAU:"Tyrosine",UAC:"Tyrosine",UAA:"Stop",UAG:"Stop",CAU:"Histidine",CAC:"Histidine",CAA:"Glutamine",CAG:"Glutamine",AAU:"Asparagine",AAC:"Asparagine",AAA:"Lysine",AAG:"Lysine",GAU:"Aspartic Acid",GAC:"Aspartic Acid",GAA:"Glutamic Acid",GAG:"Glutamic Acid",UGU:"Cysteine",UGC:"Cysteine",UGA:"Stop",UGG:"Tryptophan",CGU:"Arginine",CGC:"Arginine",CGA:"Arginine",CGG:"Arginine",AGU:"Serine",AGC:"Serine",AGA:"Arginine",AGG:"Arginine",GGU:"Glycine",GGC:"Glycine",GGA:"Glycine",GGG:"Glycine"},T={Alanine:"#FF6B6B",Arginine:"#4ECDC4",Asparagine:"#1A936F","Aspartic Acid":"#6A0572",Cysteine:"#FFD166","Glutamic Acid":"#118AB2",Glutamine:"#073B4C",Glycine:"#EF476F",Histidine:"#FFD166",Isoleucine:"#06D6A0",Leucine:"#7209B7",Lysine:"#3A86FF",Methionine:"#FB5607",Phenylalanine:"#8338EC",Proline:"#3A86FF",Serine:"#FF006E",Threonine:"#FFBE0B",Tryptophan:"#8AC926",Tyrosine:"#FF9E00",Valine:"#4361EE"},N={A:"#FF6B6B",T:"#4ECDC4",U:"#1A936F",G:"#FFD166",C:"#6A0572"},m={A:"T",T:"A",C:"G",G:"C"},y={A:"U",U:"A",C:"G",G:"C"},E={A:"U",T:"A",C:"G",G:"C"},F={A:"U",U:"A",G:"C",C:"G"};function P(e,n){if(!e)return"";let t="";for(let i=0;i<e.length;i++)t+=n[e[i]]||e[i];return t}function R(e){return N[e]||"#6C757D"}function v(n){e.val(n),W()}function S(){let n=e.val(),t=!n||0==n.length;c.prop("disabled",t),s.prop("disabled",t)}function M(e){l.text(e).fadeIn(200).addClass("error-shake"),setTimeout((()=>l.removeClass("error-shake")),500),o.hide()}function D(){l.hide().text(""),o.show()}function L(e){return P(e,m)}function x(e){return P(e,y)}function k(e){return P(e,E)}function b(e){let n="";for(let t=e.length-1;t>=0;t--)n+=F[e[t]]||e[t];return n}function I(e){let n="";for(let t=0;t<e.length;t++){let i=e[t];n+=`<span class="base-${i.toLowerCase()}">${i}</span>`}return n}function O(e){return{A:"Adenine",T:"Thymine",U:"Uracil",C:"Cytosine",G:"Guanine"}[e]||e}function _(e){return e.split("").map(O).join(", ")}function B(e,n,t,i){let l=function(e,n){if("DNA_COMPLEMENT"==n)return L(e);if("RNA_COMPLEMENT"==n)return x(e);if("DNA_TRANSCRIPT"==n)return k(e);return""}(e,n),r=`<p><strong>${function(e){return{DNA_COMPLEMENT:"Complement DNA",RNA_COMPLEMENT:"Complement RNA",DNA_TRANSCRIPT:"RNA Transcript"}[e]||""}(n)}:</strong> `;r+=i?`<span class="sequence-container">${I(l)}</span>`:l,r+="</p>",t&&(r+=`<p><strong> Input Bases:</strong> ${_(e)}</p>`,r+=`<p><strong> Output Bases:</strong> ${_(l)}</p>`),o.html(r)}function w(e,n,t,i){let l=function(e){let n=[];for(let t=0;t<e.length;t+=3){let i=e.slice(t,t+3);if(3!=i.length)return{codons:n,incomplete:i};{let e=b(i),t=U[i]||"Unknown";n.push({codon:i,anticodon:e,aminoAcid:t})}}return{codons:n,incomplete:null}}("RNA_PROTEIN"==n?e:k(e)),r=l.codons,c=l.incomplete;if(0==r.length)return void M("No complete codons found.");let s="<table><tr><th>Codon</th><th>tRNA Anticodon</th><th>Amino Acid</th></tr>";for(let e=0;e<r.length;e++){let n=r[e];s+=`<tr><td>${i?I(n.codon):n.codon}</td><td>${i?I(n.anticodon):n.anticodon}</td><td><strong>${n.aminoAcid}</strong></td></tr>`}s+="</table>",c&&(s+=`<p><strong>Incomplete codon:</strong> ${c}</p>`),t&&(s+=`<p><strong>Input Bases:</strong> ${_(e)}</p>`),o.html(s)}function q(){let t=n.val(),i=["DNA_COMPLEMENT","DNA_TRANSCRIPT","DNA_PROTEIN"].includes(t)?p:G;r.empty(),i.forEach((n=>{let t=$(`<button class="base-btn">${n}</button>`);t.on("click",(function(){let t=e.val();e.val(t+n),W()})),r.append(t)}))}function V(e,n){u.hide(),f.setTransform(1,0,0,1,0,0),f.clearRect(0,0,h.width,h.height);let t=Math.min(40*e.length+40,window.innerWidth-40),i=n.includes("PROTEIN")?150:180,o=window.devicePixelRatio||1;h.style.width=t+"px",h.style.height=i+"px",h.width=Math.round(t*o),h.height=Math.round(i*o),f.setTransform(o,0,0,o,0,0);let l=null;"RNA_PROTEIN"==n?l=e:"DNA_PROTEIN"==n&&(l=k(e)),n.includes("PROTEIN")?function(e,n,t,i){d.text("Polypeptide Chain Visualization");let o=25,l=60,r=i+o,c=t/2,s=[];for(let n=0;n<e.length;n+=3){let t=e.slice(n,n+3);if(3==t.length){let e=U[t]||"Unknown";if("Stop"==e)break;s.push({codon:t,aminoAcid:e,color:T[e]||"#6C757D",x:r+s.length*l,y:c})}}f.beginPath();for(let e=0;e<s.length-1;e++){let n=s[e],t=s[e+1];f.moveTo(n.x+o,n.y),f.lineTo(t.x-o,t.y)}function a(e){let n=h.getBoundingClientRect(),t=e.clientX-n.left,i=e.clientY-n.top,l=!1;for(let n of s){if(Math.sqrt((t-n.x)**2+(i-n.y)**2)<o){C.text(`${n.aminoAcid} (${n.codon})`).css({left:e.pageX+10,top:e.pageY-30,display:"block"}),l=!0;break}}l||C.hide()}function A(){C.hide()}f.strokeStyle="#495057",f.lineWidth=2,f.stroke(),h.removeEventListener("mousemove",a),h.removeEventListener("mouseout",A),h.addEventListener("mousemove",a),h.addEventListener("mouseout",A);for(let e of s){let{x:n,y:t,color:i,aminoAcid:l}=e;f.beginPath(),f.arc(n,t,o,0,2*Math.PI),f.fillStyle=i,f.fill(),f.strokeStyle="#343A40",f.lineWidth=1,f.stroke();let r=l.substring(0,3);f.fillStyle="#FFFFFF",f.font="bold 12px Noto Sans",f.textAlign="center",f.textBaseline="middle",f.fillText(r,n,t)}}(l||"",0,i,20):function(e,n,t,i,o){let l=40,r=20,c=i/2;d.text("Antiparallel Strands Visualization"),z(e,o,c-40,l,r,"top",n);let s="";"DNA_COMPLEMENT"==n?s=L(e):"RNA_COMPLEMENT"==n?s=x(e):"DNA_TRANSCRIPT"==n&&(s=k(e));z(s,o,c+40,l,r,"bottom",n);for(let n=0;n<e.length;n++){let e=o+n*l+l/2;f.beginPath(),f.moveTo(e,c-40+r),f.lineTo(e,c+40),f.strokeStyle="#CED4DA",f.lineWidth=1,f.stroke()}f.fillStyle="#6C757D",f.font="12px Noto Sans",f.textAlign="center",f.textBaseline="middle"}(e,n,0,i,20),u.show()}function z(e,n,t,i,o,l,r){let c="top"==l;for(let l=0;l<e.length;l++){let r=n+l*i,s=t,a=e[l]||"";f.fillStyle=R(a),f.fillRect(r,s,i,o),f.strokeStyle="#343A40",f.lineWidth=1,f.strokeRect(r,s,i,o),f.fillStyle="#FFFFFF",f.font="bold 14px Noto Sans",f.textAlign="center",f.textBaseline="middle",f.fillText(a,r+i/2,s+o/2),f.beginPath(),f.moveTo(r,s+(c?0:o)),f.lineTo(r+i,s+(c?0:o)),f.strokeStyle="#495057",f.lineWidth=3,f.stroke()}}function W(){D();let l=(e.val()||"").trim().toUpperCase(),r=n.val(),c=t.is(":checked"),s=i.is(":checked");(function(e,n){D();let t=/^[ATGC]*$/i,i=/^[AUGC]*$/i;if(""==e)return o.html(""),!0;if("RNA_PROTEIN"==n||"RNA_COMPLEMENT"==n){if(!i.test(e))return M("Invalid RNA sequence. Only A, U, G, C characters are allowed."),!1}else if(!t.test(e))return M("Invalid DNA sequence. Only A, T, G, C characters are allowed."),!1;return!0})(l,r)&&(l?V(l,r):u.hide(),g.includes(r)?B(l,r,c,s):w(l,r,c,s),S())}e.tooltip({content:"Enter DNA or RNA sequence (only A, T, G, C, U characters allowed)",position:{my:"left+10 center",at:"right center"}}),e.on("focus",(function(){$(this).addClass("highlight-effect")})).on("blur",(function(){$(this).removeClass("highlight-effect")})).on("input",W),n.on("change",(function(){q(),W()})),t.on("change",W),i.on("change",W),c.on("click",(function(){let n=e.val();n.length>0&&v(n.slice(0,-1))})),s.on("click",(function(){v(""),e.focus()})),a.on("click",(function(){let e=o.text();e?navigator.clipboard.writeText(e).then((()=>{alert("Results copied to clipboard!")})).catch((e=>{M("Failed to copy results."),console.error("Copy failed:",e)})):M("No results to copy.")})),A.on("click",(function(){e.val(""),n.val("DNA_COMPLEMENT"),t.prop("checked",!0),i.prop("checked",!0),o.html(""),u.hide(),D(),q(),S(),e.focus()})),q(),S(),e.focus()}));